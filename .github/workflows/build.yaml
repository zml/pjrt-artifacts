name: PJRT GPU library
on:
  push:
  pull_request:
  
permissions:
        contents: write
jobs:
  pjrt-artifacts:
    strategy:
      matrix:
        backend:
          # --config=${{ matrix.backend.platform }}  \
          - platform: cpu
            config: ""
            artifact: cpu
            target: //xla/pjrt/c:pjrt_c_api_cpu
    runs-on: self-hosted
    steps:
      - name: "Checking out repository"
        uses: actions/checkout@v4

      - name: Force remove container
        if: always()
        run: |
          docker rm -f pjrt-${{ matrix.backend.platform }}

      - name: "Build ${{ matrix.backend.platform }} image"
        run: bazel run //${{ matrix.backend.platform }}:${{ matrix.backend.platform }}_stripped_tarball

      - name: "Run ${{ matrix.backend.platform }} image"
        run: |
          docker run \
            --name=pjrt-${{ matrix.backend.platform }} \
            -w=/xla \
            distroless/${{ matrix.backend.platform }}_builder:latest \
              bazelisk build \
              ${{ matrix.backend.config }} --repo_env=HERMETIC_PYTHON_VERSION=3.11 \
              ${{ matrix.backend.target }}

      - name: "Retrieve artifacts"
        run: |
            docker cp pjrt-${{ matrix.backend.platform }}:/xla/bazel-bin/xla/pjrt/c/libpjrt_c_api_${{ matrix.backend.platform }}.lo .
            docker cp pjrt-${{ matrix.backend.platform }}:/xla/bazel-bin/xla/pjrt/c/libpjrt_c_api_${{ matrix.backend.platform }}.pic.lo .
            docker cp pjrt-${{ matrix.backend.platform }}:/xla/bazel-bin/xla/pjrt/c/libpjrt_c_api_${{ matrix.backend.platform }}.so .
            docker rm -f pjrt-${{ matrix.backend.platform }}

      - name: Create compressed release file
        uses: a7ul/tar-action@v1.1.0
        id: compress
        with:
          command: c
          cwd: .
          files: |
            ./libpjrt_c_api_${{ matrix.backend.platform }}.lo
            ./libpjrt_c_api_${{ matrix.backend.platform }}.pic.lo
            ./libpjrt_c_api_${{ matrix.backend.platform }}.so
          outPath: ${{ matrix.backend.platform }}.tar.gz
      
      - name: Upload ROCM artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.backend.platform }}.tar.gz
          path: ${{ matrix.backend.platform }}.tar.gz

  release:
    needs: ["pjrt-artifacts"]
    runs-on: ubuntu-22.04
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      if: startsWith(github.ref, 'refs/tags/')
      with:
        path: release
    - name: Release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          rocm.tar.gz
          cuda.tar.gz
          cpu.tar.gz
