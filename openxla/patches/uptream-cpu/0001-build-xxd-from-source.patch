From b0156afb4a34968d0fd44605c0c2860e19151848 Mon Sep 17 00:00:00 2001
From: Corentin Kerisit <corentin.kerisit@gmail.com>
Date: Mon, 16 Feb 2026 09:56:37 +0000
Subject: [PATCH 1/2] build xxd from source

---
 MODULE.bazel            | 1 +
 xla/util/build_defs.bzl | 3 ++-
 2 files changed, 3 insertions(+), 1 deletion(-)

diff --git a/MODULE.bazel b/MODULE.bazel
index 96ee3999e2..8416f467e1 100644
--- a/MODULE.bazel
+++ b/MODULE.bazel
@@ -28,6 +28,7 @@ bazel_dep(name = "rules_license", version = "1.0.0")
 bazel_dep(name = "rules_python", version = "1.6.3")
 bazel_dep(name = "rules_shell", version = "0.6.1")
 bazel_dep(name = "snappy", version = "1.2.1")
+bazel_dep(name = "xxd", version = "9.1.0917")
 bazel_dep(name = "zlib", version = "1.3.1.bcr.5")
 # go/keep-sorted end
 
diff --git a/xla/util/build_defs.bzl b/xla/util/build_defs.bzl
index a5d3192bf5..5b44634925 100644
--- a/xla/util/build_defs.bzl
+++ b/xla/util/build_defs.bzl
@@ -41,6 +41,7 @@ def embed_files(name, srcs, cpp_namespace = "", compatible_with = None, **kwargs
             name + ".cc",
             name + ".h",
         ],
+        tools = ["@xxd//:xxd"],
         cmd = """
             HDR_OUT=$(location {name}.h)
             CC_OUT=$(location {name}.cc)
@@ -76,7 +77,7 @@ def embed_files(name, srcs, cpp_namespace = "", compatible_with = None, **kwargs
                 echo "const std::string& $${{FUNC_NAME}}();" >> "$${{HDR_OUT}}"
 
                 # CC: Embed data using xxd
-                xxd -i "$${{src}}" | \
+                $(location @xxd//:xxd) -i "$${{src}}" | \
                 sed -e "s/^unsigned char [^[]*/static const unsigned char $${{VAR_NAME}}/" \
                     -e "s/^unsigned int .*_len/static const size_t $${{VAR_NAME}}_size/" \
                     >> "$${{CC_OUT}}"
-- 
2.48.1

