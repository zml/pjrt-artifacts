From f142d7907ae77fe849ff11cddbec8b1b60c934e7 Mon Sep 17 00:00:00 2001
From: Hugo Mano <hugo@zml.ai>
Date: Tue, 27 May 2025 11:50:40 +0200
Subject: [PATCH 3/6] Expose nvptxcompiler to link against in XLA if
 enable_libnvptxcompiler_support is set

Only for ZML, no PR on XLA side.
---
 third_party/gpus/cuda/hermetic/BUILD.tpl           | 1 +
 third_party/gpus/cuda/hermetic/cuda_nvcc.BUILD.tpl | 8 ++++++++
 xla/stream_executor/cuda/BUILD                     | 7 ++++++-
 3 files changed, 15 insertions(+), 1 deletion(-)

diff --git a/third_party/gpus/cuda/hermetic/BUILD.tpl b/third_party/gpus/cuda/hermetic/BUILD.tpl
index 41a273ebbe..d789e71883 100644
--- a/third_party/gpus/cuda/hermetic/BUILD.tpl
+++ b/third_party/gpus/cuda/hermetic/BUILD.tpl
@@ -307,6 +307,7 @@ cc_library(
     # This is not yet fully supported, but we need the rule
     # to make bazel query happy.
     name = "nvptxcompiler",
+    actual = "@cuda_nvcc//:libnvptxcompiler",
 )
 
 alias(
diff --git a/third_party/gpus/cuda/hermetic/cuda_nvcc.BUILD.tpl b/third_party/gpus/cuda/hermetic/cuda_nvcc.BUILD.tpl
index 733d95d371..f6c1c5ab53 100644
--- a/third_party/gpus/cuda/hermetic/cuda_nvcc.BUILD.tpl
+++ b/third_party/gpus/cuda/hermetic/cuda_nvcc.BUILD.tpl
@@ -52,6 +52,14 @@ filegroup(
     visibility = ["//visibility:public"],
 )
 
+filegroup(
+    name = "libnvptxcompiler",
+    srcs = [
+        "lib/libnvptxcompiler_static.a",
+    ],
+    visibility = ["//visibility:public"],
+)
+
 filegroup(
     name = "bin",
     srcs = glob([
diff --git a/xla/stream_executor/cuda/BUILD b/xla/stream_executor/cuda/BUILD
index 08abf6197f..ac06e394bc 100644
--- a/xla/stream_executor/cuda/BUILD
+++ b/xla/stream_executor/cuda/BUILD
@@ -124,7 +124,12 @@ cc_library(
             "@tsl//tsl/platform:errors",
             "@tsl//tsl/platform:status",
             "@tsl//tsl/platform:statusor",
-        ] + tf_additional_cuda_platform_deps(),
+        ] + tf_additional_cuda_platform_deps() + select({
+            ":libnvptxcompiler_support_enabled": [
+                "@local_config_cuda//cuda:nvptxcompiler",
+            ],
+            "//conditions:default": [],
+        }),
     alwayslink = True,  # Registers itself with the PlatformManager.
 )
 
-- 
2.39.5 (Apple Git-154)

